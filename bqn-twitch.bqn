ssw â† â€¢Import "ssw.bqn"

crlfâ€¿esc â† @+âŸ¨13â€¿10,27âŸ©

url â† "irc.chat.twitch.tv"
port â† "6667"
utc â† -4

Send â‡ { 
  bytes_sent â† ssw.Send ğ•©â€¿ğ•¨â€¿(â‰ ğ•¨) 
  ! bytes_sent > 0
  ğ•©
}

Read â‡ {
  bytes_readâ€¿c â† ssw.Read ğ•©â€¿ğ•¨â€¿(â‰ ğ•¨)
  ! bytes_read â‰¥ 0
  (â†•bytes_read)âŠc
}


Auth â‡ {
  nickâ€¿uat â† ğ•¨
  ("PASS oauth:"âˆ¾uatâˆ¾crlf) Send ğ•©
  ("NICK "âˆ¾nickâˆ¾crlf) Send ğ•©
  ğ•©
}

Connect â‡ {
  nickâ€¿uat â† ğ•©
  stream â† ssw.NewStream (urlâˆ¾@)â€¿(portâˆ¾@)
  ğ•© Auth stream
}

Disconnect â‡ ssw.DestroyStream

Join â‡ {
  ("JOIN "âˆ¾ğ•¨âˆ¾crlf) Send ğ•©
}

RequestCap â‡ {
  c â† crlfâˆ¾Ëœ"CAP REQ :"âˆ¾âˆ¾âŸœ" "âŠ¸âˆ¾Â´"twitch.tv/"âŠ¸âˆ¾Â¨ğ•¨
  c Send ğ•©
}

SendChannelMsg â‡ {
  châ€¿msg â† ğ•¨
  ("PRIVMSG "âˆ¾châˆ¾" :"âˆ¾msgâˆ¾crlf) Send ğ•©
}

ReadFullMsgs â‡ {
  r â† ğ•¨âˆ¾ğ•© # concat last partial message (ğ•¨) with new messages (ğ•©)
  m â† Ã—âˆ˜â‰ Â¨âŠ¸/ crlf SplitStr r # split on crlf and remove empty lists
  dlm â† -(@+10)â‰ Â¯1âŠ‘r # drop last message if it doesn't end in nl
  dlm(â†“â‹ˆâˆ¾âˆ˜â†‘)m # return list of full messages and partial message
}

HandlePing â‡ {
  ("PONG :"âˆ¾ğ•¨âˆ¾crlf) Send ğ•©
}

PrintPrivMsg â‡ {
  uâ€¿câ€¿tsâ†{(1âŠ¸â†“"="âŠ¸SplitStr)Â¨ â¥Š/âŸœğ•©Ë˜(+Â´Â¨("display-name="â€¿"color="â€¿"tmi-sent-ts=")â·âŒœğ•©)}";" SplitStr ğ•©.t # get display name, color, and timestamp from tags
  tsâ†© 1â†“âˆ¾(':'âˆ¾Â«âŸœ"00"âˆ˜â€¢Fmt)Â¨ utc TimeFromEpoch 1000Ã·Ëœâ€¢ParseFloat âŠ‘ts # parse time and fmt hh:mm:ss
  câ†© Hex2RGB 1â†“1âŠ¸=âˆ˜â‰ â—¶âŸ¨"#FF0000",âŠ‘âŸ©c # parse color string or default to red if missing
  mâ†(1âŠ¸+âˆ˜âŠ‘âˆ˜/âˆ˜(':'âŠ¸=)â†“â†•âˆ˜â‰ )âŠ¸âŠğ•©.p # msg is everything after the first ':'
  â€¢Out tsâˆ¾" "âˆ¾(c Colorize âŠ‘u)âˆ¾": "âˆ¾m
}

HandleMsg â‡ {
  "PING" â‰¡ ğ•¨.c ? ğ•¨ HandlePing ğ•©; # if ping message reply pong
  "PRIVMSG" â‰¡ ğ•¨.c ? PrintPrivMsg ğ•¨;
  â€¢Out ğ•¨.câˆ¾" "âˆ¾ğ•¨.p
}

Msg â‡ {
  tâ€¿sâ€¿câ€¿p â‡ âŸ¨âŸ©â€¿âŸ¨âŸ©â€¿âŸ¨âŸ©â€¿âŸ¨âŸ©
  Parse â‡ { # parse message into its tag, source, command, parameters
    ptâ†" " SplitStr ğ•©
    { '@'=âŠ‘âŠ‘pt ? tâ†©âŠ‘pt â‹„ pt 1âŠ¸â†“â†©;@}
    { ':'=âŠ‘âŠ‘pt ? sâ†©âŠ‘pt â‹„ pt 1âŠ¸â†“â†©;@}
    câ†©âŠ‘pt â‹„ pt 1âŠ¸â†“â†©
    pâ†©âˆ¾âŸœ" "âŠ¸âˆ¾Â´pt
  }
  Parse ğ•©
}


#########
# Utils #
#########

TimeFromEpoch â‡ {
    los â† ğ•©|Ëœ24Ã—60Ã—60 # left over seconds
    h â† âŒŠlosÃ·60Ã—60
    m â† âŒŠ60Ã·Ëœlos|Ëœ60Ã—60
    s â† âŒŠ60|los
    (24|ğ•¨ + h)â€¿mâ€¿s
}

Colorize â‡ {
  râ€¿gâ€¿b â† â€¢FmtÂ¨ğ•¨
  escâˆ¾"[38;2;"âˆ¾râˆ¾";"âˆ¾gâˆ¾";"âˆ¾bâˆ¾"m"âˆ¾ğ•©âˆ¾escâˆ¾"[0m"
}

Hex2RGB â‡ {
  rgb â† >âŸœ15â—¶âŸ¨âŠ£,-âŸœ('A'-':')âŸ©Â¨ğ•©-'0'
  +ËË˜3â€¿2â¥ŠrgbÃ—âˆ¾3/â‹ˆ16â€¿1
}

SplitStr â‡ {
  ğ•©âŠ”Ëœ(+`âˆ§Â¬)âŠ¸-+Â´ğ•©âŠ¸=Â¨ ğ•¨ # split ğ•© on ğ•¨
}

StrFromPtr â‡ {
  @ + ğ•©.ReadÂ¨ â†• ssw.StrLen ğ•©
}

GetEnvVar â‡ {
  StrFromPtr ssw.GetEnv (ğ•©âˆ¾@)
}
