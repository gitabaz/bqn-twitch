ssw â† â€¢Import "ssw.bqn"

crlf â† @+13â€¿10

url â† "irc.chat.twitch.tv"
port â† "6667"

Send â‡ { 
  bytes_sent â† ssw.Send ğ•©â€¿ğ•¨â€¿(â‰ ğ•¨) 
  ! bytes_sent > 0
  ğ•©
}

Read â‡ {
  bytes_readâ€¿c â† ssw.Read ğ•©â€¿ğ•¨â€¿(â‰ ğ•¨)
  ! bytes_read â‰¥ 0
  (â†•bytes_read)âŠc
}


Auth â‡ {
  nickâ€¿uat â† ğ•¨
  ("PASS oauth:"âˆ¾uatâˆ¾crlf) Send ğ•©
  ("NICK "âˆ¾nickâˆ¾crlf) Send ğ•©
  ğ•©
}

Connect â‡ {
  nickâ€¿uat â† ğ•©
  stream â† ssw.NewStream (urlâˆ¾@)â€¿(portâˆ¾@)
  ğ•© Auth stream
}

Disconnect â‡ ssw.DestroyStream

Join â‡ {
  ("JOIN "âˆ¾ğ•¨âˆ¾crlf) Send ğ•©
}

RequestCap â‡ {
  c â† crlfâˆ¾Ëœ"CAP REQ :"âˆ¾âˆ¾âŸœ" "âŠ¸âˆ¾Â´"twitch.tv/"âŠ¸âˆ¾Â¨ğ•¨
  c Send ğ•©
}

SendChannelMsg â‡ {
  châ€¿msg â† ğ•¨
  ("PRIVMSG "âˆ¾châˆ¾" :"âˆ¾msgâˆ¾crlf) Send ğ•©
}

ReadFullMsgs â‡ {
  r â† ğ•¨âˆ¾ğ•© # concat last partial message (ğ•¨) with new messages (ğ•©)
  m â† Ã—âˆ˜â‰ Â¨âŠ¸/ crlf SplitStr r # split on crlf and remove empty lists
  dlm â† -(@+10)â‰ Â¯1âŠ‘r # drop last message if it doesn't end in nl
  dlm(â†“â‹ˆâˆ¾âˆ˜â†‘)m # return list of full messages and partial message
}

#########
# Utils #
#########

SplitStr â‡ {
  ğ•©âŠ”Ëœ(+`âˆ§Â¬)âŠ¸-+Â´ğ•©âŠ¸=Â¨ ğ•¨ # split ğ•© on ğ•¨
}

StrFromPtr â‡ {
  @ + ğ•©.ReadÂ¨ â†• ssw.StrLen ğ•©
}

GetEnvVar â‡ {
  StrFromPtr ssw.GetEnv (ğ•©âˆ¾@)
}
