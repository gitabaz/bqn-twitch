ssw â† â€¢Import "ssw.bqn"

crlf â† @+13â€¿10

url â† "irc.chat.twitch.tv"
port â† "6667"

cap_req â† "CAP REQ :twitch.tv/membership twitch.tv/tags twitch.tv/commands"âˆ¾crlf

Send â‡ { 
  bytes_sent â† ssw.Send ğ•©â€¿ğ•¨â€¿(â‰ ğ•¨) 
  ! bytes_sent > 0
  ğ•©
}

Read â‡ {
  bytes_readâ€¿c â† ssw.Read ğ•©â€¿ğ•¨â€¿(â‰ ğ•¨)
  ! bytes_read â‰¥ 0
  (â†•bytes_read)âŠc
}


Auth â‡ {
  nickâ€¿uat â† ğ•¨
  ("PASS oauth:"âˆ¾uatâˆ¾crlf) Send ğ•©
  ("NICK "âˆ¾nickâˆ¾crlf) Send ğ•©
  ğ•©
}

Connect â‡ {
  nickâ€¿uat â† ğ•©
  stream â† ssw.NewStream (urlâˆ¾@)â€¿(portâˆ¾@)
  ğ•© Auth stream
}

Disconnect â‡ ssw.DestroyStream

Join â‡ {
  ("JOIN "âˆ¾ğ•¨âˆ¾crlf) Send ğ•©
}

SendChannelMsg â‡ {
  châ€¿msg â† ğ•¨
  ("PRIVMSG "âˆ¾châˆ¾" :"âˆ¾msgâˆ¾crlf) Send ğ•©
}

ReadFullMsgs â‡ {
  r â† ğ•¨âˆ¾ğ•© # concat last partial message (ğ•¨) with new messages (ğ•©)
  m â† râŠ”Ëœ(+`âˆ§Â¬)âŠ¸-+Â´râŠ¸=Â¨crlf # split on crlf
  m â†© Ã—âˆ˜â‰ Â¨âŠ¸/ m # remove empty lists
  dlm â† -(@+10)â‰ Â¯1âŠ‘r # drop last message if it doesn't end in nl
  dlm(â†“â‹ˆâˆ¾âˆ˜â†‘)m # return list of full messages and partial message
}

#########
# Utils #
#########

StrFromPtr â‡ {
  @ + ğ•©.ReadÂ¨ â†• ssw.StrLen ğ•©
}

GetEnvVar â‡ {
  StrFromPtr ssw.GetEnv (ğ•©âˆ¾@)
}
