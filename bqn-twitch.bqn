ssw â† â€¢Import "ssw.bqn"

crlfâ€¿esc â† @+âŸ¨13â€¿10,27âŸ©

url â† "irc.chat.twitch.tv"
port â† "6667"
utc â† -4

Send â‡ { 
  bytes_sent â† ssw.Send ğ•©â€¿ğ•¨â€¿(â‰ ğ•¨) 
  ! bytes_sent > 0
  ğ•©
}

Read â‡ {
  bytes_readâ€¿c â† ssw.Read ğ•©â€¿ğ•¨â€¿(â‰ ğ•¨)
  ! bytes_read â‰¥ 0
  (â†•bytes_read)âŠc
}


Auth â‡ {
  nickâ€¿uat â† ğ•¨
  ("PASS oauth:"âˆ¾uatâˆ¾crlf) Send ğ•©
  ("NICK "âˆ¾nickâˆ¾crlf) Send ğ•©
  ğ•©
}

Connect â‡ {
  nickâ€¿uat â† ğ•©
  stream â† ssw.NewStream (urlâˆ¾@)â€¿(portâˆ¾@)
  ğ•© Auth stream
}

Disconnect â‡ ssw.DestroyStream

Join â‡ {
  ("JOIN "âˆ¾ğ•¨âˆ¾crlf) Send ğ•©
}

RequestCap â‡ {
  c â† crlfâˆ¾Ëœ"CAP REQ :"âˆ¾âˆ¾âŸœ" "âŠ¸âˆ¾Â´"twitch.tv/"âŠ¸âˆ¾Â¨ğ•¨
  c Send ğ•©
}

SendChannelMsg â‡ {
  châ€¿msg â† ğ•¨
  ("PRIVMSG "âˆ¾châˆ¾" :"âˆ¾msgâˆ¾crlf) Send ğ•©
}

ReadFullMsgs â‡ {
  r â† ğ•¨âˆ¾ğ•© # concat last partial message (ğ•¨) with new messages (ğ•©)
  m â† Ã—âˆ˜â‰ Â¨âŠ¸/ crlf SplitStr r # split on crlf and remove empty lists
  dlm â† -(@+10)â‰ Â¯1âŠ‘r # drop last message if it doesn't end in nl
  dlm(â†“â‹ˆâˆ¾âˆ˜â†‘)m # return list of full messages and partial message
}

HandlePing â‡ {
  ("PONG :"âˆ¾ğ•¨âˆ¾crlf) Send ğ•©
}

HandlePrivMsg â‡ {
  â€¢Out "<"âˆ¾(âŠ‘"!" SplitStr 1âŠ‘ğ•¨)âˆ¾"> "âˆ¾(2âŠ‘ğ•¨)
  ğ•©
}

HandleMsg â‡ {
  p â† ":" SplitStr ğ•¨ # split messages on : to get pieces
  ğ•¨ {
    "PING "â‰¡âŠ‘p ? (Â¯1âŠ‘p) HandlePing ğ•©; # if ping message reply pong
    "PRIVMSG" â‰¡ 1âŠ‘" "SplitStr 1âŠ‘p ? p HandlePrivMsg ğ•©;
    â€¢Show ğ•¨
  } ğ•©
  ğ•©
}

#########
# Utils #
#########

TimeFromEpoch â‡ {
    los â† ğ•©|Ëœ24Ã—60Ã—60 # left over seconds
    h â† âŒŠlosÃ·60Ã—60
    m â† âŒŠ60Ã·Ëœlos|Ëœ60Ã—60
    s â† âŒŠ60|los
    (24|ğ•¨ + h)â€¿mâ€¿s
}

Colorize â‡ {
  râ€¿gâ€¿b â† â€¢FmtÂ¨ğ•¨
  escâˆ¾"[38;2;"âˆ¾râˆ¾";"âˆ¾gâˆ¾";"âˆ¾bâˆ¾"m"âˆ¾ğ•©âˆ¾escâˆ¾"[0m"
}

Hex2RGB â‡ {
  rgb â† >âŸœ15â—¶âŸ¨âŠ£,-âŸœ('A'-':')âŸ©Â¨ğ•©-'0'
  rgb â†© 16âŠ¸Ã—âŒ¾(0â€¿2â€¿4âŠ¸âŠ) rgb
  +Â´Â¨âŠâŸœrgbÂ¨âŸ¨0â€¿1,2â€¿3,4â€¿5âŸ©
}

SplitStr â‡ {
  ğ•©âŠ”Ëœ(+`âˆ§Â¬)âŠ¸-+Â´ğ•©âŠ¸=Â¨ ğ•¨ # split ğ•© on ğ•¨
}

StrFromPtr â‡ {
  @ + ğ•©.ReadÂ¨ â†• ssw.StrLen ğ•©
}

GetEnvVar â‡ {
  StrFromPtr ssw.GetEnv (ğ•©âˆ¾@)
}
